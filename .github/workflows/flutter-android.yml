name: ðŸ¤– Flutter Android CI
run-name: "ðŸš€ Android Build by ${{ github.actor }} on ${{ github.ref_name }}"

permissions:
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  android-ci: 
    runs-on: ubuntu-latest 
    
    permissions:
      contents: read
      checks: write
      pull-requests: write

    

    steps:
      # ------------------------------
      # Checkout
      # ------------------------------
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ------------------------------
      # Setup Flutter
      # ------------------------------
      - name: âš™ï¸ Setup Flutter (3.35.7 Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: ðŸ§¾ Check Flutter & Dart version
        run: |
          flutter --version
          dart --version

      # ------------------------------
      # Install Dependencies
      # ------------------------------
      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      # ------------------------------
      # Lint
      # ------------------------------
      - name: ðŸ” Lint Check
        run: flutter analyze --no-fatal-infos --no-fatal-warnings || true

      # ------------------------------
      # Install formatter to convert test output to JUnit XML
      # ------------------------------
      - name: ðŸ“¦ Install junitreport
        run: dart pub global activate junitreport

     # ------------------------------
      # Run Tests (Machine-readable â†’ JUnit XML)
      # ------------------------------
      - name: ðŸ“¦ Install junitreport
        run: dart pub global activate junitreport
      
      - name: ðŸ§ª Run Tests (JUnit Output)
        run: |
          # make sure global pub executables are on the PATH
          export PATH="$HOME/.pub-cache/bin:$PATH"
      
          # run machine-mode flutter tests (capture output even on failure)
          flutter test --machine --no-pub > test_output.json || true
      
          # convert flutter machine-json to JUnit xml using junitreport
          # use dart pub global run to ensure the tool is executed
          dart pub global run junitreport:tojunit < test_output.json > test-results.xml || true
        continue-on-error: true
      
      # ------------------------------
      # Publish Tests (GitHub Checks Tab)
      # ------------------------------
      - name: ðŸ“ˆ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Flutter Test Results
          path: test-results.xml
          reporter: java-junit
          fail-on-error: false
          # annotate-only: true


      # ------------------------------
      # Step Summary (Clean + Pretty)
      # ------------------------------
      - name: ðŸ§¾ Add Lint + Test Summary
        if: always()
        run: |
          echo "## ðŸ§© Flutter CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
          # -------------------------
          # Lint Summary
          # -------------------------
          echo "### ðŸ” Lint Warnings" >> $GITHUB_STEP_SUMMARY
          flutter analyze --no-fatal-infos --no-fatal-warnings | tail -n 20 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
          # -------------------------
          # Test Summary (Pretty)
          # -------------------------
          echo "### ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
      
          TOTAL=$(grep -o "<testcase" test-results.xml | wc -l)
          FAILED=$(grep -o "<failure" test-results.xml | wc -l)
          PASSED=$((TOTAL - FAILED))
      
          echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** ðŸŸ¢ $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ðŸ”´ $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
          # -------------------------
          # Failed test names
          # -------------------------
          if [ "$FAILED" -gt 0 ]; then
            echo "#### âŒ Failed Tests:" >> $GITHUB_STEP_SUMMARY
            grep -oP '(?<=testcase name=").+?(?=")' test-results.xml | head -n 10 >> $GITHUB_STEP_SUMMARY
          else
            echo "All tests passed ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          fi
          
# -----------------------------------------
# JOB 2: DEPLOY (Only on main + CI success)
# -----------------------------------------
  android-deploy:
    name: "ðŸš€ Android Deploy to Google Play"
    runs-on: ubuntu-latest
    needs: android-ci        # CI must pass first
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      # Checkout
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Setup Flutter
      - name: âš™ï¸ Setup Flutter (3.35.7 Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: ðŸ§¾ Check Flutter & Dart version
        run: |
          flutter --version
          dart --version

      # Install dependencies
      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      # Decode keystore
      - name: ðŸ” Decode Android Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > android.keystore

      # Create key.properties
      - name: ðŸ”§ Configure Signing
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../android.keystore
          EOF

      # Build AAB
      - name: ðŸ—ï¸ Build AAB for Play Store
        run: flutter build appbundle --release

      # Build APK
      - name: ðŸ—ï¸ Build APK
        run: flutter build apk --release

      # Upload artifacts
      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

      # Setup Ruby + Fastlane
      - name: ðŸ”§ Setup Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - run: gem install fastlane -N

      # Deploy to Google Play
      - name: ðŸš€ Deploy to Google Play (Internal Track)
        env:
          JSON_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          PACKAGE_NAME: ${{ secrets.PACKAGE_NAME }}
        run: |
          echo "$JSON_KEY" > service_account.json
          fastlane supply \
            --aab build/app/outputs/bundle/release/app-release.aab \
            --json_key service_account.json \
            --package_name "$PACKAGE_NAME" \
            --track internal \
            --skip_upload_screenshots true \
            --skip_upload_images true
